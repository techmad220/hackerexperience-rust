<!DOCTYPE html>
<html lang="{{language|default:'en'}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{meta_description|default:'HackerExperience - The Ultimate Hacking Simulation Game'}}">
    <meta name="keywords" content="hacker, simulation, game, programming, security, rust">
    <meta name="author" content="HackerExperience Team">
    
    <title>{{page_title|default:'HackerExperience'}} - {{site_title|default:'Rust Edition'}}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/images/favicon.png">
    <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/game-core.css">
    <link rel="stylesheet" href="/assets/css/game-components.css">
    <link rel="stylesheet" href="/assets/css/game-themes.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="/assets/css/themes/{{current_theme|default:'dark'}}.css" id="theme-css">
    
    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Meta tags for social sharing -->
    <meta property="og:title" content="{{page_title|default:'HackerExperience'}}">
    <meta property="og:description" content="{{meta_description|default:'The Ultimate Hacking Simulation Game'}}">
    <meta property="og:image" content="/assets/images/og-image.png">
    <meta property="og:url" content="{{canonical_url}}">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{page_title|default:'HackerExperience'}}">
    <meta name="twitter:description" content="{{meta_description|default:'The Ultimate Hacking Simulation Game'}}">
    <meta name="twitter:image" content="/assets/images/twitter-card.png">
    
    <!-- Game Configuration -->
    <script>
        window.GAME_CONFIG = {
            apiUrl: '{{api_url|default:'/api'}}',
            wsUrl: '{{websocket_url|default:'ws://localhost:8080/ws'}}',
            version: '{{game_version|default:'2.0.0'}}',
            build: '{{build_number|default:'dev'}}',
            environment: '{{environment|default:'development'}}',
            features: {{enabled_features|safe}},
            user: {{user_data|safe}},
            csrf_token: '{{csrf_token}}',
            session_id: '{{session.session_id}}',
            language: '{{language|default:'en'}}',
            theme: '{{current_theme|default:'dark'}}',
            debug: {{debug_mode|yesno:"true,false"}},
            maintenance: {{maintenance_mode|yesno:"true,false"}}
        };
    </script>
</head>
<body class="{{body_class|default:'game-interface'}} theme-{{current_theme|default:'dark'}}" 
      data-page="{{current_page}}" 
      data-user-id="{{user.id}}" 
      data-session-id="{{session.session_id}}">
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen" {% if not show_loading %}style="display: none;"{% endif %}>
        <div class="loading-content">
            <div class="logo-container">
                <img src="/assets/images/logo.svg" alt="HackerExperience" class="logo">
                <h1 class="game-title">HACKER EXPERIENCE</h1>
                <p class="game-subtitle">{{site_subtitle|default:'Rust Edition'}}</p>
            </div>
            <div class="loading-progress">
                <div class="loading-bar">
                    <div class="loading-fill" id="loading-fill"></div>
                </div>
                <div class="loading-text" id="loading-text">Initializing systems...</div>
            </div>
        </div>
    </div>

    <!-- Maintenance Mode Banner -->
    {% if maintenance_mode %}
    <div class="maintenance-banner">
        <div class="container">
            <i class="fas fa-wrench"></i>
            <span>System maintenance in progress. Some features may be unavailable.</span>
        </div>
    </div>
    {% endif %}

    <!-- Flash Messages -->
    {% if session.isset_msg %}
    <div class="flash-messages">
        <div class="container">
            {{session.return_msg|safe}}
        </div>
    </div>
    {% endif %}

    <!-- Main Application Container -->
    <div id="app" class="app-container">
        {% if user_authenticated %}
            <!-- Authenticated Layout -->
            {% include 'partials/authenticated-layout.html' %}
        {% else %}
            <!-- Public Layout -->
            {% include 'partials/public-layout.html' %}
        {% endif %}
    </div>

    <!-- Modal System -->
    <div id="modal-system">
        <!-- Generic Modal -->
        <div id="modal-overlay" class="modal-overlay" style="display: none;">
            <div class="modal modal-lg" id="main-modal">
                <div class="modal-header">
                    <h3 id="modal-title" class="modal-title">Modal Title</h3>
                    <button class="modal-close" id="modal-close" type="button" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Modal content -->
                </div>
                <div class="modal-footer" id="modal-footer">
                    <!-- Modal buttons -->
                </div>
            </div>
        </div>

        <!-- Process Modal -->
        <div id="process-modal" class="modal-overlay" style="display: none;">
            <div class="modal modal-process">
                <div class="modal-header">
                    <h3 class="modal-title">Process Monitor</h3>
                    <button class="modal-close" data-modal="process-modal" type="button">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="process-details">
                        <!-- Process details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Software Modal -->
        <div id="software-modal" class="modal-overlay" style="display: none;">
            <div class="modal modal-software">
                <div class="modal-header">
                    <h3 class="modal-title">Software Details</h3>
                    <button class="modal-close" data-modal="software-modal" type="button">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="software-details">
                        <!-- Software details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Hardware Modal -->
        <div id="hardware-modal" class="modal-overlay" style="display: none;">
            <div class="modal modal-hardware">
                <div class="modal-header">
                    <h3 class="modal-title">Hardware Specifications</h3>
                    <button class="modal-close" data-modal="hardware-modal" type="button">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="hardware-details">
                        <!-- Hardware details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="modal-overlay" style="display: none;">
            <div class="modal modal-sm modal-confirm">
                <div class="modal-header">
                    <h3 class="modal-title">Confirm Action</h3>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">Are you sure you want to perform this action?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="confirm-cancel">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-ok">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container">
        <!-- Toast notifications will be added here -->
    </div>

    <!-- Context Menus -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <ul class="context-menu-list" id="context-menu-list">
            <!-- Context menu items -->
        </ul>
    </div>

    <!-- Tooltips -->
    <div id="tooltip" class="tooltip" style="display: none;">
        <div class="tooltip-content" id="tooltip-content"></div>
        <div class="tooltip-arrow" id="tooltip-arrow"></div>
    </div>

    <!-- Audio System -->
    <div id="audio-system" style="display: none;">
        <audio id="notification-sound" preload="auto">
            <source src="/assets/sounds/notification.ogg" type="audio/ogg">
            <source src="/assets/sounds/notification.mp3" type="audio/mpeg">
        </audio>
        <audio id="process-complete-sound" preload="auto">
            <source src="/assets/sounds/process-complete.ogg" type="audio/ogg">
            <source src="/assets/sounds/process-complete.mp3" type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source src="/assets/sounds/error.ogg" type="audio/ogg">
            <source src="/assets/sounds/error.mp3" type="audio/mpeg">
        </audio>
        <audio id="success-sound" preload="auto">
            <source src="/assets/sounds/success.ogg" type="audio/ogg">
            <source src="/assets/sounds/success.mp3" type="audio/mpeg">
        </audio>
    </div>

    <!-- Core JavaScript Libraries -->
    <script src="/assets/js/libs/jquery.min.js"></script>
    <script src="/assets/js/libs/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/libs/moment.min.js"></script>
    <script src="/assets/js/libs/lodash.min.js"></script>
    <script src="/assets/js/libs/Chart.min.js"></script>

    <!-- Core Game Scripts -->
    <script src="/assets/js/core/utils.js"></script>
    <script src="/assets/js/core/config.js"></script>
    <script src="/assets/js/core/events.js"></script>
    <script src="/assets/js/core/api-client.js"></script>
    <script src="/assets/js/core/websocket-client.js"></script>
    <script src="/assets/js/core/session-manager.js"></script>
    <script src="/assets/js/core/notification-system.js"></script>
    <script src="/assets/js/core/modal-manager.js"></script>
    <script src="/assets/js/core/theme-manager.js"></script>
    <script src="/assets/js/core/audio-manager.js"></script>

    <!-- Game Logic Scripts -->
    <script src="/assets/js/game/process-manager.js"></script>
    <script src="/assets/js/game/software-manager.js"></script>
    <script src="/assets/js/game/hardware-manager.js"></script>
    <script src="/assets/js/game/network-manager.js"></script>
    <script src="/assets/js/game/banking-system.js"></script>
    <script src="/assets/js/game/clan-system.js"></script>
    <script src="/assets/js/game/mission-system.js"></script>
    <script src="/assets/js/game/ranking-system.js"></script>
    <script src="/assets/js/game/terminal.js"></script>

    <!-- UI Components -->
    <script src="/assets/js/components/data-table.js"></script>
    <script src="/assets/js/components/progress-bar.js"></script>
    <script src="/assets/js/components/chart-component.js"></script>
    <script src="/assets/js/components/file-browser.js"></script>
    <script src="/assets/js/components/network-scanner.js"></script>
    <script src="/assets/js/components/code-editor.js"></script>

    <!-- Page-specific Scripts -->
    {% block extra_js %}{% endblock %}

    <!-- Main Application -->
    <script src="/assets/js/app.js"></script>

    <!-- Initialize Application -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the game application
            if (typeof HackerExperience !== 'undefined') {
                HackerExperience.init(window.GAME_CONFIG);
            } else {
                console.error('HackerExperience application not loaded');
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            if (window.GAME_CONFIG && window.GAME_CONFIG.debug) {
                // Show error details in debug mode
                HackerExperience.showError('JavaScript Error', e.error.toString());
            }
        });

        // Unhandled promise rejection handling
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled Promise Rejection:', e.reason);
            if (window.GAME_CONFIG && window.GAME_CONFIG.debug) {
                HackerExperience.showError('Promise Rejection', e.reason.toString());
            }
        });
    </script>

    <!-- Analytics and Tracking -->
    {% if not debug_mode and analytics_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{analytics_id}}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{analytics_id}}');
    </script>
    {% endif %}

    <!-- Service Worker Registration -->
    {% if enable_pwa %}
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('SW registered: ', registration);
                }).catch(function(registrationError) {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>
    {% endif %}
</body>
</html>